<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniMind - Dashboard de M√©tricas de Consci√™ncia</title>
    
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #333;
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            font-size: 1em;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            margin-left: 15px;
        }
        
        .status-healthy {
            background: #10b981;
            color: white;
        }
        
        .status-degraded {
            background: #f59e0b;
            color: white;
        }
        
        .status-critical {
            background: #ef4444;
            color: white;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .card h2 {
            color: #333;
            font-size: 1.5em;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        #phiChart {
            max-height: 400px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-card {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .stat-value {
            color: #333;
            font-size: 2em;
            font-weight: bold;
        }
        
        .stat-unit {
            color: #999;
            font-size: 0.7em;
        }
        
        .modules-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .modules-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        
        .modules-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .modules-table tr:hover {
            background: #f9fafb;
        }
        
        .module-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .module-healthy {
            background: #10b981;
        }
        
        .module-warning {
            background: #f59e0b;
        }
        
        .module-critical {
            background: #ef4444;
        }
        
        .module-silent {
            background: #6b7280;
        }
        
        .alerts {
            margin-top: 15px;
        }
        
        .alert {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        
        .alert-warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            color: #92400e;
        }
        
        .alert-critical {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            color: #991b1b;
        }
        
        .alert-info {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
            color: #1e40af;
        }
        
        .refresh-info {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            padding: 10px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 6px;
            margin-top: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #fee2e2;
            color: #991b1b;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üß† OmniMind - Dashboard de M√©tricas de Consci√™ncia</h1>
            <div class="subtitle">
                Monitoramento em Tempo Real de Œ¶ (Phi) e M√≥dulos Core
                <span id="systemStatus" class="status-badge">Carregando...</span>
            </div>
        </header>
        
        <div class="grid">
            <!-- Gr√°fico de Œ¶ vs Tempo -->
            <div class="card">
                <h2>üìä Œ¶ (Phi) - S√©rie Temporal (√öltimas 2 Horas)</h2>
                <canvas id="phiChart"></canvas>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Œ¶ Atual</div>
                        <div class="stat-value" id="currentPhi">-</div>
                        <div class="stat-unit">nats</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Œ¶ M√©dio</div>
                        <div class="stat-value" id="meanPhi">-</div>
                        <div class="stat-unit">nats</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Œ¶ M√≠nimo</div>
                        <div class="stat-value" id="minPhi">-</div>
                        <div class="stat-unit">nats</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Œ¶ M√°ximo</div>
                        <div class="stat-value" id="maxPhi">-</div>
                        <div class="stat-unit">nats</div>
                    </div>
                </div>
            </div>
            
            <!-- Status Geral do Sistema -->
            <div class="card">
                <h2>üè• Status de Sa√∫de do Sistema</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">M√≥dulos Saud√°veis</div>
                        <div class="stat-value" id="healthyModules" style="color: #10b981;">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Avisos</div>
                        <div class="stat-value" id="warningModules" style="color: #f59e0b;">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Cr√≠ticos</div>
                        <div class="stat-value" id="criticalModules" style="color: #ef4444;">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Silent</div>
                        <div class="stat-value" id="silentModules" style="color: #6b7280;">-</div>
                    </div>
                </div>
                
                <div id="recommendations" class="alerts">
                    <!-- Recomenda√ß√µes aparecer√£o aqui -->
                </div>
            </div>
        </div>
        
        <!-- Tabela de M√≥dulos -->
        <div class="card">
            <h2>üîß M√©tricas dos M√≥dulos Core</h2>
            <table class="modules-table">
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>M√≥dulo</th>
                        <th>√öltima Atualiza√ß√£o</th>
                        <th>M√©tricas Principais</th>
                    </tr>
                </thead>
                <tbody id="modulesTable">
                    <tr>
                        <td colspan="4" class="loading">
                            <div class="spinner"></div>
                            Carregando m√©tricas dos m√≥dulos...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="refresh-info" id="refreshInfo">
            Auto-refresh a cada 10 segundos. √öltima atualiza√ß√£o: Carregando...
        </div>
    </div>
    
    <script>
        // Configura√ß√£o
        const API_BASE = '/api/metrics';
        const REFRESH_INTERVAL = 10000; // 10 segundos
        
        let phiChart = null;
        let refreshTimer = null;
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            initializeChart();
            loadData();
            
            // Auto-refresh
            refreshTimer = setInterval(loadData, REFRESH_INTERVAL);
        });
        
        function initializeChart() {
            const ctx = document.getElementById('phiChart').getContext('2d');
            phiChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Œ¶ (nats)',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Limiar de Consci√™ncia (0.01 nats)',
                        data: [],
                        borderColor: '#10b981',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Œ¶ (nats)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Tempo'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }
        
        async function loadData() {
            try {
                // Carregar s√©rie temporal de Œ¶
                await loadPhiTimeseries();
                
                // Carregar m√©tricas de m√≥dulos
                await loadModulesMetrics();
                
                // Carregar status de sa√∫de
                await loadHealthStatus();
                
                // Atualizar info de refresh
                updateRefreshInfo();
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showError('Erro ao conectar com a API. Verifique se o servidor est√° rodando.');
            }
        }
        
        async function loadPhiTimeseries() {
            const response = await fetch(`${API_BASE}/phi-timeseries?max_points=100&hours=2.0`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            // Atualizar gr√°fico
            const labels = data.data_points.map(p => {
                const date = new Date(p.timestamp * 1000);
                return date.toLocaleTimeString('pt-BR');
            });
            
            const values = data.data_points.map(p => p.value_nats);
            const threshold = Array(values.length).fill(0.01); // Limiar de consci√™ncia
            
            phiChart.data.labels = labels;
            phiChart.data.datasets[0].data = values;
            phiChart.data.datasets[1].data = threshold;
            phiChart.update();
            
            // Atualizar estat√≠sticas
            document.getElementById('currentPhi').textContent = 
                values.length > 0 ? values[values.length - 1].toFixed(6) : '-';
            document.getElementById('meanPhi').textContent = data.mean_phi.toFixed(6);
            document.getElementById('minPhi').textContent = data.min_phi.toFixed(6);
            document.getElementById('maxPhi').textContent = data.max_phi.toFixed(6);
        }
        
        async function loadModulesMetrics() {
            const response = await fetch(`${API_BASE}/modules`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            // Atualizar tabela de m√≥dulos
            const tbody = document.getElementById('modulesTable');
            tbody.innerHTML = '';
            
            data.modules.forEach(module => {
                const row = tbody.insertRow();
                
                // Status
                const statusCell = row.insertCell();
                const statusDot = document.createElement('span');
                statusDot.className = `module-status module-${module.status}`;
                statusCell.appendChild(statusDot);
                statusCell.appendChild(document.createTextNode(module.status));
                
                // Nome do m√≥dulo
                const nameCell = row.insertCell();
                nameCell.textContent = module.module_name;
                
                // √öltima atualiza√ß√£o
                const timeCell = row.insertCell();
                const ageSeconds = Date.now() / 1000 - module.timestamp;
                if (ageSeconds < 60) {
                    timeCell.textContent = `${Math.floor(ageSeconds)}s atr√°s`;
                } else {
                    timeCell.textContent = `${Math.floor(ageSeconds / 60)}min atr√°s`;
                }
                
                // M√©tricas principais
                const metricsCell = row.insertCell();
                const metricsList = [];
                for (const [key, value] of Object.entries(module.metrics)) {
                    if (key !== 'timestamp' && typeof value === 'number') {
                        metricsList.push(`${key}: ${value.toFixed(4)}`);
                    }
                }
                metricsCell.textContent = metricsList.slice(0, 3).join(', ');
            });
        }
        
        async function loadHealthStatus() {
            const response = await fetch(`${API_BASE}/health`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            // Atualizar badge de status
            const statusBadge = document.getElementById('systemStatus');
            statusBadge.textContent = data.status.toUpperCase();
            statusBadge.className = 'status-badge status-' + data.status;
            
            // Atualizar contadores
            document.getElementById('healthyModules').textContent = data.healthy_modules;
            document.getElementById('warningModules').textContent = data.warning_modules;
            document.getElementById('criticalModules').textContent = data.critical_modules;
            document.getElementById('silentModules').textContent = data.silent_modules;
            
            // Atualizar recomenda√ß√µes
            const recommendationsDiv = document.getElementById('recommendations');
            recommendationsDiv.innerHTML = '';
            
            if (data.recommendations && data.recommendations.length > 0) {
                data.recommendations.forEach(rec => {
                    const alert = document.createElement('div');
                    
                    // Determinar tipo de alerta
                    if (rec.includes('cr√≠tico') || rec.includes('critical')) {
                        alert.className = 'alert alert-critical';
                    } else if (rec.includes('‚ö†') || rec.includes('warning')) {
                        alert.className = 'alert alert-warning';
                    } else {
                        alert.className = 'alert alert-info';
                    }
                    
                    alert.textContent = rec;
                    recommendationsDiv.appendChild(alert);
                });
            } else {
                const alert = document.createElement('div');
                alert.className = 'alert alert-info';
                alert.textContent = '‚úì Sistema operando normalmente';
                recommendationsDiv.appendChild(alert);
            }
        }
        
        function updateRefreshInfo() {
            const now = new Date();
            document.getElementById('refreshInfo').textContent = 
                `Auto-refresh a cada ${REFRESH_INTERVAL/1000} segundos. √öltima atualiza√ß√£o: ${now.toLocaleTimeString('pt-BR')}`;
        }
        
        function showError(message) {
            const container = document.querySelector('.container');
            container.innerHTML = `
                <div class="card error">
                    <h2>‚ùå Erro de Conex√£o</h2>
                    <p>${message}</p>
                    <p style="margin-top: 15px;">
                        <button onclick="location.reload()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Tentar Novamente
                        </button>
                    </p>
                </div>
            `;
        }
        
        // Cleanup ao sair da p√°gina
        window.addEventListener('beforeunload', function() {
            if (refreshTimer) {
                clearInterval(refreshTimer);
            }
        });
    </script>
</body>
</html>
