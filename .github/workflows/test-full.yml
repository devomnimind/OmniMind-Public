name: Test - Full Suite (Nightly)

# Full comprehensive test suite - runs on schedule
# Includes: quantum, ml, benchmarks, stress tests
# Manual dispatch available for validation

on:
  schedule:
    # Run every night at 2 AM UTC (10 PM EST)
    - cron: '0 2 * * *'
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths:
      - 'src/quantum_consciousness/**'
      - 'src/quantum_ai/**'
      - 'tests/quantum_**'
      - '.github/workflows/test-full.yml'

jobs:
  test-full:
    name: Full Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3 hours for full suite
    if: false  # DISABLED: Tests n√£o executam no CI

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-full-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-full-

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libdbus-1-dev pkg-config build-essential libssl-dev libffi-dev libglib2.0-dev meson ninja-build

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-timeout

    - name: Create test reports directory
      run: mkdir -p data/test_reports

    - name: Run full test suite
      run: |
        echo "üß™ Running full test suite (including quantum, ml, benchmarks)..."
        pytest tests/ \
          -v \
          --tb=short \
          --timeout=60 \
          --maxfail=50 \
          --durations=25 \
          --cov=src \
          --cov-report=term-missing \
          --cov-report=json:data/test_reports/coverage.json \
          --cov-report=html:data/test_reports/htmlcov \
          -W ignore::DeprecationWarning \
          2>&1 | tee data/test_reports/pytest_full.log || EXIT_CODE=$?
        echo "Exit code: ${EXIT_CODE:-0}"

    - name: Generate coverage report
      if: always()
      run: |
        echo "üìä COVERAGE REPORT" >> $GITHUB_STEP_SUMMARY
        if [ -f data/test_reports/coverage.json ]; then
          echo "- Coverage report generated" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload test reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: full-test-reports-${{ github.run_id }}
        path: data/test_reports/
        retention-days: 30

    - name: Notify on failure
      if: failure()
      run: |
        echo "‚ùå Full test suite failed!"
        echo "Check the uploaded artifacts for details."
