#!/usr/bin/env python3
"""
Script para inicializar cole√ß√µes Qdrant do OmniMind.

Este script cria todas as cole√ß√µes necess√°rias para o funcionamento
completo do sistema OmniMind no Qdrant.

Cole√ß√µes criadas:
- omnimind_consciousness: Dados de consci√™ncia e estados mentais
- omnimind_episodes: Mem√≥ria epis√≥dica e experi√™ncias
- omnimind_embeddings: Embeddings de c√≥digo e documentos
- omnimind_narratives: Narrativas hist√≥ricas e hist√≥rias
- omnimind_system: Dados do sistema e metadados

Uso:
    python init_qdrant_collections.py

Requisitos:
- Qdrant rodando em localhost:6333
- qdrant-client instalado
"""

import logging
import sys
from pathlib import Path

# Adicionar src ao path
project_root = Path(__file__).parent.parent.parent
sys.path.insert(0, str(project_root / "src"))

try:
    from qdrant_client import QdrantClient
    from qdrant_client.models import Distance, VectorParams
except ImportError:
    print("‚ùå qdrant-client n√£o instalado. Instale com: pip install qdrant-client")
    sys.exit(1)

# Configurar logging
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s"
)
logger = logging.getLogger(__name__)

# Defini√ß√µes das cole√ß√µes
COLLECTIONS = {
    "omnimind_consciousness": {
        "description": "Dados de consci√™ncia e estados mentais",
        "vector_size": 768,  # all-mpnet-base-v2
        "distance": Distance.COSINE
    },
    "omnimind_episodes": {
        "description": "Mem√≥ria epis√≥dica e experi√™ncias",
        "vector_size": 768,
        "distance": Distance.COSINE
    },
    "omnimind_embeddings": {
        "description": "Embeddings de c√≥digo e documentos",
        "vector_size": 768,
        "distance": Distance.COSINE
    },
    "omnimind_narratives": {
        "description": "Narrativas hist√≥ricas e hist√≥rias",
        "vector_size": 768,
        "distance": Distance.COSINE
    },
    "omnimind_system": {
        "description": "Dados do sistema e metadados",
        "vector_size": 384,  # all-MiniLM-L6-v2
        "distance": Distance.COSINE
    },
    "omnimind_memories": {
        "description": "Mem√≥rias gerais do sistema",
        "vector_size": 768,
        "distance": Distance.COSINE
    }
}

def init_qdrant_collections():
    """Inicializar todas as cole√ß√µes Qdrant necess√°rias"""

    # Conectar ao Qdrant
    try:
        client = QdrantClient(url="http://localhost:6333")
        logger.info("‚úÖ Conectado ao Qdrant em localhost:6333")
    except Exception as e:
        logger.error(f"‚ùå Falha ao conectar ao Qdrant: {e}")
        return False

    # Verificar cole√ß√µes existentes
    try:
        existing_collections = client.get_collections().collections
        existing_names = [col.name for col in existing_collections]
        logger.info(f"üìã Cole√ß√µes existentes: {existing_names}")
    except Exception as e:
        logger.error(f"‚ùå Erro ao listar cole√ß√µes: {e}")
        return False

    # Criar cole√ß√µes necess√°rias
    created_count = 0
    for collection_name, config in COLLECTIONS.items():
        if collection_name in existing_names:
            logger.info(f"‚è≠Ô∏è  Cole√ß√£o '{collection_name}' j√° existe - pulando")
            continue

        try:
            # Criar cole√ß√£o
            client.create_collection(
                collection_name=collection_name,
                vectors_config=VectorParams(
                    size=config["vector_size"],
                    distance=config["distance"]
                )
            )

            logger.info(f"‚úÖ Criada cole√ß√£o '{collection_name}': {config['description']}")
            logger.info(f"   üìè Dimens√£o: {config['vector_size']}, Dist√¢ncia: {config['distance'].value}")

            created_count += 1

        except Exception as e:
            logger.error(f"‚ùå Erro ao criar cole√ß√£o '{collection_name}': {e}")
            return False

    # Verificar cria√ß√£o
    try:
        final_collections = client.get_collections().collections
        final_names = [col.name for col in final_collections]
        logger.info(f"üìã Cole√ß√µes finais: {sorted(final_names)}")

        # Verificar se todas as cole√ß√µes necess√°rias existem
        missing = []
        for collection_name in COLLECTIONS.keys():
            if collection_name not in final_names:
                missing.append(collection_name)

        if missing:
            logger.error(f"‚ùå Cole√ß√µes faltando: {missing}")
            return False

    except Exception as e:
        logger.error(f"‚ùå Erro ao verificar cole√ß√µes finais: {e}")
        return False

    logger.info(f"üéâ Inicializa√ß√£o completa! {created_count} cole√ß√µes criadas.")
    return True

def main():
    """Fun√ß√£o principal"""
    logger.info("üöÄ Iniciando inicializa√ß√£o das cole√ß√µes Qdrant do OmniMind")

    success = init_qdrant_collections()

    if success:
        logger.info("‚úÖ Todas as cole√ß√µes foram inicializadas com sucesso!")
        sys.exit(0)
    else:
        logger.error("‚ùå Falha na inicializa√ß√£o das cole√ß√µes")
        sys.exit(1)

if __name__ == "__main__":
    main()
