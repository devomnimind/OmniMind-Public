#!/bin/bash
# ðŸ›¡ï¸ OmniMind Permission Setup
# Gera configuraÃ§Ã£o do sudoers para permitir execuÃ§Ã£o autÃ´noma segura.

set -e

USER_NAME=$(whoami)
CONFIG_FILE="/etc/sudoers.d/omnimind_autonomous"
TEMP_FILE="omnimind_sudoers.tmp"

echo "ðŸ›¡ï¸ Configurando PermissÃµes AutÃ´nomas para OmniMind..."
echo "   UsuÃ¡rio: $USER_NAME"

# Define os comandos permitidos (deve bater com privileged_commands.yaml)
# NOPASSWD permite execuÃ§Ã£o sem senha (evita travamento)
cat > $TEMP_FILE <<EOF
# OmniMind Autonomous Permissions
# Generated by scripts/setup_permissions.sh on $(date)

# Permitir monitoramento eBPF
$USER_NAME ALL=(ALL) NOPASSWD: /usr/bin/bpftrace

# Permitir limpeza de processos do projeto
$USER_NAME ALL=(ALL) NOPASSWD: /usr/bin/pkill

# Permitir gerenciamento Docker
$USER_NAME ALL=(ALL) NOPASSWD: /usr/bin/docker

# Permitir leitura de logs do sistema
$USER_NAME ALL=(ALL) NOPASSWD: /usr/bin/journalctl, /usr/bin/dmesg

# Permitir ferramentas de rede e seguranÃ§a (Network Security)
$USER_NAME ALL=(ALL) NOPASSWD: /usr/bin/nmap, /usr/bin/ss, /usr/bin/tcpdump, /usr/sbin/iptables

# Permitir gerenciamento de serviÃ§os e hardware
$USER_NAME ALL=(ALL) NOPASSWD: /usr/bin/systemctl, /usr/sbin/smartctl
EOF

echo "âœ… Arquivo de configuraÃ§Ã£o gerado: $TEMP_FILE"
echo "---------------------------------------------------"
cat $TEMP_FILE
echo "---------------------------------------------------"
echo ""
echo "âš ï¸  AÃ‡ÃƒO NECESSÃRIA:"
echo "Para ativar a autonomia do agente, execute o comando abaixo (pedirÃ¡ senha 1 vez):"
echo ""
echo "   sudo mv $TEMP_FILE $CONFIG_FILE && sudo chown root:root $CONFIG_FILE && sudo chmod 0440 $CONFIG_FILE"
echo ""
echo "ApÃ³s isso, o OmniMind poderÃ¡ executar tarefas de seguranÃ§a sem travar."
