# Network Policies for OmniMind
# Implements zero-trust network security model

---
# Default deny all ingress traffic
# This establishes the baseline: no pods can receive traffic unless explicitly allowed
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: omnimind
  labels:
    app: omnimind
    policy-type: security
spec:
  podSelector: {}
  policyTypes:
  - Ingress

---
# Default deny all egress traffic
# Pods cannot initiate connections unless explicitly allowed
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-egress
  namespace: omnimind
  labels:
    app: omnimind
    policy-type: security
spec:
  podSelector: {}
  policyTypes:
  - Egress

---
# Allow frontend to communicate with backend
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-frontend-to-backend
  namespace: omnimind
  labels:
    app: omnimind
    policy-type: application
spec:
  podSelector:
    matchLabels:
      component: backend
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          component: frontend
    ports:
    - protocol: TCP
      port: 8000

---
# Allow ingress controller to reach backend
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ingress-to-backend
  namespace: omnimind
  labels:
    app: omnimind
    policy-type: application
spec:
  podSelector:
    matchLabels:
      component: backend
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 8000

---
# Allow ingress controller to reach frontend
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ingress-to-frontend
  namespace: omnimind
  labels:
    app: omnimind
    policy-type: application
spec:
  podSelector:
    matchLabels:
      component: frontend
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 4173

---
# Allow all pods to access DNS
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-access
  namespace: omnimind
  labels:
    app: omnimind
    policy-type: infrastructure
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53

---
# Allow backend to access external APIs (optional, enable if needed)
# Uncomment if backend needs to call external services
# apiVersion: networking.k8s.io/v1
# kind: NetworkPolicy
# metadata:
#   name: allow-backend-external
#   namespace: omnimind
#   labels:
#     app: omnimind
#     policy-type: application
# spec:
#   podSelector:
#     matchLabels:
#       component: backend
#   policyTypes:
#   - Egress
#   egress:
#   - to:
#     - ipBlock:
#         cidr: 0.0.0.0/0
#         except:
#         - 10.0.0.0/8
#         - 172.16.0.0/12
#         - 192.168.0.0/16
#     ports:
#     - protocol: TCP
#       port: 443
#     - protocol: TCP
#       port: 80

---
# Allow pods to communicate within namespace (inter-pod communication)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-same-namespace
  namespace: omnimind
  labels:
    app: omnimind
    policy-type: application
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector: {}
  egress:
  - to:
    - podSelector: {}
