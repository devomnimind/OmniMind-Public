"""Playbook to scan, quarantine, and harden the system against malware."""

import logging
from typing import Any, Dict, List

from .utils import (
    CommandResult,
    command_available,
    run_command_async,
    skipped_command,
)

logger = logging.getLogger(__name__)


class MalwarePlaybook:
    """Handles malware scanning, quarantine, and verification."""

    async def execute(self, agent: Any, event: Any) -> Dict[str, Any]:
        logger.info(
            "ðŸš¨ [MALWARE] response start for %s",
            getattr(event, "event_type", "malware"),
        )
        scans = await self._run_malware_scans()
        quarantine = await self._quarantine_samples(event, scans)
        signatures = await self._refresh_signatures()
        notification = await self._notify_team(event)
        verification = await self._verify_cleanup()
        return {
            "status": "completed",
            "scans": scans,
            "quarantine": quarantine,
            "signatures": signatures,
            "notification": notification,
            "verification": verification,
        }

    async def _run_malware_scans(self) -> Dict[str, CommandResult]:
        logger.debug("   [1/5] Running malware detection suites")
        tools: List[List[str]] = [
            ["/usr/bin/clamscan", "-r", "/"],
            ["/usr/bin/maldet", "-a", "/"],
            ["/usr/bin/chkrootkit"],
        ]
        results: Dict[str, CommandResult] = {}
        for command in tools:
            name = command[0]
            if not command_available(name):
                results[name] = skipped_command(name, "tool unavailable")
                continue
            results[name] = await run_command_async(command)
        return results

    async def _quarantine_samples(self, event: Any, scans: Dict[str, Any]) -> Dict[str, Any]:
        logger.debug("   [2/5] Quarantining artifacts")
        artifact = None
        if hasattr(event, "details") and isinstance(event.details, dict):
            artifact = event.details.get("path") or event.details.get("file")
        os_command = ["sudo", "mkdir", "-p", "/opt/omnimind/quarantine"]
        quarantine_root = (
            await run_command_async(os_command)
            if command_available(os_command[0])
            else skipped_command("mkdir", "mkdir missing")
        )
        if not artifact:
            return {"quarantine_root": quarantine_root, "artifact": None}
        move_command = ["sudo", "mv", str(artifact), "/opt/omnimind/quarantine/"]
        move_result: CommandResult
        if not command_available(move_command[0]):
            move_result = skipped_command("mv", "mv missing")
        else:
            move_result = await run_command_async(move_command)
        return {
            "quarantine_root": quarantine_root,
            "artifact": artifact,
            "move": move_result,
        }

    async def _refresh_signatures(self) -> CommandResult:
        logger.debug("   [3/5] Refreshing antivirus signatures")
        command = ["sudo", "freshclam"]
        if not command_available(command[0]):
            return skipped_command("freshclam", "tool unavailable")
        return await run_command_async(command)

    async def _notify_team(self, event: Any) -> CommandResult:
        logger.debug("   [4/5] Notifying team about the incident")
        description = getattr(event, "description", "malware detected")
        message = f"Malware playbook executed: {description}"
        return await run_command_async(["/bin/echo", message])

    async def _verify_cleanup(self) -> Dict[str, CommandResult]:
        logger.debug("   [5/5] Running follow-up scan to verify cleanup")
        return await self._run_malware_scans()
